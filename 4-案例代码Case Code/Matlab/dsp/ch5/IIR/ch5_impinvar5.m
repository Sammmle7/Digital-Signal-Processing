% Zhou Zhiguo
% 2019.5.1
% Ch5 数字滤波器设计
% 脉冲响应不变变换法---impinvar
% 题目：课本 P194
% 说明：采用修订版 buttord_z 函数
clear; 
close all;
clc;

%--------------------------------------------------------------------------
% 要求：
%--------------------------------------------------------------------------
% 采用脉冲响应不变变换法，设计数字巴特沃斯滤波器
% 通带 Wp = 0.2*pi     1dB
% 阻带 Ws = 0.3~1*pi   15dB
% 求：N,H(z),H(ejw),直接-I

%--------------------------------------------------------------------------
% 条件：
%--------------------------------------------------------------------------
T = 1;          %采样间隔：s
fs = 1;         %采样频率：Hz 
Wp = 0.2*pi;    %数字频率：通带截止 0-pi
Ws = 0.3*pi;    %数字频率：阻带起始 0-pi
Ap = 1;         %通带衰减：dB
As = 15;        %阻带衰减：dB

wp = Wp/T;      %模拟角频率：rad
ws = Ws/T;      %模拟角频率：rad
fp = wp/(2*pi); %模拟频率：Hz 
fst = ws/(2*pi);%模拟频率：Hz 

%--------------------------------------------------------------------------
% 求N，wc：
%--------------------------------------------------------------------------
[N,wc] = buttord_z(wp,ws,Ap,As,'s'); 
%采用修订版 buttord_z 函数
%N=6，wc = 0.7032
%wc = 0.7087 满足阻带要求，给通带留裕量
%wc = 0.7032 满足通带要求，给阻带留裕量

%--------------------------------------------------------------------------
%模拟原型滤波器，求H(s)：
%--------------------------------------------------------------------------
[Bs,As] = butter(N,wc,'s');
%B =      0         0         0         0         0         0    0.1209
%A = 1.0000    2.7170    3.6910    3.1788    1.8252    0.6644    0.1209

%辅助1：传递函数hs
hs = tf(Bs,As);
zpk(hs);
% hs =
%                                   0.1209
%   -----------------------------------------------------------------------
%   s^6 + 2.717 s^5 + 3.691 s^4 + 3.179 s^3 + 1.825 s^2 + 0.6644 s + 0.1209

%辅助2：传递函数-二次分式
zsys = zpk(hs); 
% zsys =
%  
%                                   0.12092
%   ------------------------------------------------------------------------
%   (s^2 + 1.358s + 0.4945) (s^2 + 0.9945s + 0.4945) (s^2 + 0.364s + 0.4945)

%辅助3：部分分式展开
[r,p,k] = residue(Bs,As);
% r =
%   -1.0714 + 0.0000i
%   -1.0714 - 0.0000i
%    0.1435 + 0.2486i
%    0.1435 - 0.2486i
%    0.9279 - 1.6071i
%    0.9279 + 1.6071i

% p =
%   -0.4972 + 0.4972i
%   -0.4972 - 0.4972i
%   -0.1820 + 0.6792i
%   -0.1820 - 0.6792i
%   -0.6792 + 0.1820i
%   -0.6792 - 0.1820i

% hs =
%       0.9279 - 1.6071i             0.9279 + 1.6071i
%   ------------------------  +  ------------------------- 
%    s-(-0.6792 + 0.1820i)         s-(-0.6792 - 0.1820i)
% +
%       0.1435 + 0.2486i             0.1435 - 0.2486i
%   ------------------------  +  ------------------------- 
%    s-(-0.1820 + 0.6792i)         s-(-0.1820 - 0.6792i)
% +
%       -1.0714 + 0.0000i             -1.0714 - 0.0000i
%   ------------------------  +  ------------------------- 
%    s-(-0.4972 + 0.4972i)         s-(-0.4972 - 0.4972i)


%辅助4：波特图
Hs = tf(Bs,As);
bode(Hs);
grid on;

%--------------------------------------------------------------------------
% 采用脉冲响应不变变换法设计：
%--------------------------------------------------------------------------
[Dz,Cz] = impinvar(Bs,As,fs); 
%D = -0.0000    0.0006    0.0101    0.0161    0.0041    0.0001         0
%C =  1.0000   -3.3635    5.0684   -4.2759    2.1066   -0.5706    0.0661
%H(z)=
%        0.0006*z^5 + 0.0101*z^4 + 0.0161*z^3 + 0.0041*z^2 + 0.0001*z
%  -------------------------------------------------------------------------
%  z^6 -3.3625*z^5 + 5.0648*z^4 -4.2759*z^3 + 2.1066*z^2 -0.5706*z + 0.0661

Hz = filt(Dz,Cz);
%Hz =
% 
%  -1.066e-14 + 0.000631 z^-1 + 0.0101 z^-2 + 0.01614 z^-3 + 0.004101 z^-4 + 0.0001033 z^-5
%  ----------------------------------------------------------------------------------------
%     1 - 3.364 z^-1 + 5.068 z^-2 - 4.276 z^-3 + 2.107 z^-4 - 0.5706 z^-5 + 0.06607 z^-6



%--------------------------------------------------------------------------
% 画幅频、相频图：
%--------------------------------------------------------------------------
figure;
W = linspace(0,pi);       
H = freqz(Dz,Cz,W);
mag = abs(H)/abs(H(1));
dbmag = 20*log10(mag);
phase = angle(H);           %输出scale:-pi~pi
degphase = phase*180/pi;    %转为degree

subplot(3,1,1), plot(W,abs(H))
grid on;
xlabel('Frequency (0~\pi)');
xlim([0 pi]);
xticks(0:0.1*pi:pi);
xticklabels({'0','0.1\pi','0.2\pi','0.3\pi','0.4\pi','0.5\pi','0.6\pi','0.7\pi','0.8\pi','0.9\pi','\pi'})
ylabel('Magnitude');
title('数字滤波器 频率-幅度');

subplot(3,1,2), plot(W,dbmag)
grid on;
xlabel('Frequency (0~\pi)');
xlim([0 pi]);
xticks(0:0.1*pi:pi);
xticklabels({'0','0.1\pi','0.2\pi','0.3\pi','0.4\pi','0.5\pi','0.6\pi','0.7\pi','0.8\pi','0.9\pi','\pi'})
ylabel('Magnitude （dB）');
title('数字滤波器 频率-幅度 dB');

subplot(3,1,3), plot(W,degphase)
grid on;
xlabel('Frequency (0~\pi)');
xlim([0 pi]);
xticks(0:0.1*pi:pi);
xticklabels({'0','0.1\pi','0.2\pi','0.3\pi','0.4\pi','0.5\pi','0.6\pi','0.7\pi','0.8\pi','0.9\pi','\pi'})
ylabel('Phase (degrees)');
title('数字滤波器 频率-相位');

%--------------------------------------------------------------------------
% 画极零图：
%--------------------------------------------------------------------------
figure;
[z,p,k] = tf2zp(Dz,Cz);
zplane(z,p);
xlim([-1 1]);
ylim([-1 1]);
grid on;
title('6th-Order Buttworth Lowpass Digital Filter')

figure;
zplane(Dz,Cz);
xlim([-1 1]);
ylim([-1 1]);
grid on;
title('6th-Order Buttworth Lowpass Digital Filter')
